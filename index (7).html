<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GARDEN</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    html, body { height: 100%; }
    body { margin: 0; overflow: hidden; background: #020617; }
    canvas { touch-action: none; }

    .glass { background: rgba(2, 6, 23, 0.58); backdrop-filter: blur(12px); }

    .btn {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      transition: transform .08s ease, background .15s ease, border-color .15s ease, filter .2s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn:hover { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.16); }

    .primary {
      background: linear-gradient(135deg, rgba(16,185,129,0.95), rgba(34,197,94,0.85));
      color: #052e16;
      border: 1px solid rgba(16,185,129,0.35);
      box-shadow: 0 14px 35px rgba(16,185,129,0.15);
    }
    .primary:hover { filter: brightness(1.05); }

    .menu-btn {
      width: 100%;
      border-radius: 18px;
      padding: 14px 16px;
      font-weight: 900;
      letter-spacing: .2px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      transition: transform .12s ease, background .18s ease, border-color .18s ease;
    }
    .menu-btn:hover { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.18); }
    .menu-btn:active { transform: translateY(1px); }

    .menu-primary {
      background: linear-gradient(135deg, rgba(16,185,129,0.95), rgba(34,197,94,0.85));
      color: #052e16;
      border: 1px solid rgba(16,185,129,0.35);
      box-shadow: 0 18px 40px rgba(16,185,129,0.12);
    }

    .chip {
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
    }
    .chip[aria-pressed="true"] {
      border-color: rgba(16,185,129,0.45);
      background: rgba(16,185,129,0.12);
      box-shadow: inset 0 0 0 1px rgba(16,185,129,0.18);
    }

    .dpad-btn {
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.10);
      transition: background .15s ease;
      font-weight: 800;
    }
    .dpad-btn:active { background: rgba(255,255,255,0.20); }

    .kbd { font-variant-numeric: tabular-nums; }

    .panel-enter { animation: panelEnter .18s ease-out; }
    @keyframes panelEnter {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    input[type="range"] {
      accent-color: rgb(16 185 129);
    }

    /* Kids-style logo */
    .kids-logo {
      font-family: ui-rounded, "Comic Sans MS", system-ui, -apple-system, Segoe UI, Tahoma, Arial;
      letter-spacing: 1.2px;
      text-shadow: 0 2px 0 rgba(0,0,0,0.22), 0 10px 25px rgba(16,185,129,0.18);
    }
    .kids-badge {
      background: linear-gradient(135deg, rgba(250,204,21,0.95), rgba(34,197,94,0.90), rgba(56,189,248,0.85));
      color: rgba(2,6,23,0.92);
      border: 1px solid rgba(255,255,255,0.20);
      box-shadow: 0 16px 45px rgba(250,204,21,0.10), 0 20px 60px rgba(34,197,94,0.10);
    }
    .kids-chip {
      background: rgba(250,204,21,0.10);
      border: 1px solid rgba(250,204,21,0.22);
      color: rgba(254,249,195,0.95);
    }

    /* Menu vibes (more motion & hype) */
    .menu-scene { isolation: isolate; }

    .menu-aurora {
      pointer-events: none;
      opacity: 0.55;
      mix-blend-mode: screen;
      filter: blur(42px) saturate(1.25);
      background:
        radial-gradient(900px 420px at 20% 20%, rgba(34,197,94,0.18), transparent 60%),
        radial-gradient(760px 360px at 80% 18%, rgba(56,189,248,0.14), transparent 62%),
        radial-gradient(900px 520px at 60% 80%, rgba(250,204,21,0.12), transparent 62%),
        radial-gradient(circle at 18% 60%, rgba(250,204,21,0.08) 0 2px, transparent 3px),
        radial-gradient(circle at 55% 35%, rgba(56,189,248,0.07) 0 2px, transparent 3px),
        radial-gradient(circle at 78% 72%, rgba(34,197,94,0.07) 0 2px, transparent 3px);
      background-size: auto, auto, auto, 220px 220px, 260px 260px, 240px 240px;
      animation: auroraMove 10s ease-in-out infinite alternate;
    }
    @keyframes auroraMove {
      from { transform: translate3d(-10px, 0, 0) scale(1.02); opacity: .48; }
      to   { transform: translate3d(14px, -8px, 0) scale(1.08); opacity: .62; }
    }

    .menu-grass {
      pointer-events: none;
      opacity: 0.9;
      filter: blur(0.4px);
      background:
        linear-gradient(to top, rgba(5,46,22,0.85), rgba(5,46,22,0.10), transparent),
        repeating-linear-gradient(90deg,
          rgba(34,197,94,0.10) 0px,
          rgba(34,197,94,0.10) 6px,
          rgba(16,185,129,0.00) 6px,
          rgba(16,185,129,0.00) 16px);
      background-size: 100% 100%, 220px 100%;
      animation: grassSway 6.8s ease-in-out infinite alternate;
    }
    @keyframes grassSway {
      from { background-position: 0 0, 0 0; }
      to { background-position: 0 0, 220px 0; }
    }

    .menu-card {
      --rx: 0deg;
      --ry: 0deg;
      --lift: 0px;
      transform: perspective(900px) rotateX(var(--rx)) rotateY(var(--ry)) translateY(var(--lift));
      transform-style: preserve-3d;
      transition: transform .18s ease;
      will-change: transform;
    }

    .menu-sheen { position: relative; overflow: hidden; }
    .menu-sheen::after {
      content: "";
      position: absolute;
      inset: -60% -80%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,0.10) 48%, transparent 62%);
      transform: translateX(-55%) rotate(12deg);
      animation: sheen 5.5s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes sheen {
      0%, 30% { transform: translateX(-70%) rotate(12deg); opacity: 0.0; }
      45% { opacity: 0.55; }
      70% { opacity: 0.22; }
      100% { transform: translateX(70%) rotate(12deg); opacity: 0.0; }
    }

    .logo-pop { animation: logoPop 2.8s ease-in-out infinite; }
    @keyframes logoPop {
      0%, 100% { transform: translateY(0) rotate(-1deg); filter: saturate(1.05); }
      50% { transform: translateY(-3px) rotate(1deg); filter: saturate(1.25); }
    }

    .menu-tagline.swap { animation: taglineSwap .55s ease; }
    @keyframes taglineSwap {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cta-btn { position: relative; overflow: hidden; }
    .cta-btn { animation: ctaPulse 1.6s ease-in-out infinite; }
    .cta-btn::before {
      content: "";
      position: absolute;
      inset: -2px;
      background: radial-gradient(200px 70px at 20% 20%, rgba(250,204,21,0.35), transparent 60%);
      opacity: 0.85;
      pointer-events: none;
    }
    .cta-btn::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(110deg, transparent 35%, rgba(255,255,255,0.14) 50%, transparent 65%);
      transform: translateX(-70%);
      animation: ctaShine 2.4s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes ctaPulse {
      0%, 100% { transform: translateY(0) scale(1); box-shadow: 0 18px 40px rgba(16,185,129,0.12); }
      50% { transform: translateY(-2px) scale(1.02); box-shadow: 0 22px 55px rgba(250,204,21,0.12), 0 18px 45px rgba(16,185,129,0.15); }
    }
    @keyframes ctaShine {
      0%, 35% { transform: translateX(-75%); opacity: 0; }
      55% { opacity: 0.55; }
      100% { transform: translateX(75%); opacity: 0; }
    }

    /* Floating petals + fireflies */
    .petal {
      position: absolute;
      left: var(--left);
      top: var(--top);
      width: var(--size);
      height: calc(var(--size) * 0.72);
      border-radius: 999px 999px 999px 120px;
      background: linear-gradient(135deg, var(--c1), var(--c2));
      opacity: var(--op);
      filter: blur(0.2px);
      transform: rotate(var(--rot));
      animation: petalFall var(--dur) linear infinite;
    }
    @keyframes petalFall {
      0%   { transform: translate3d(0, 0, 0) rotate(var(--rot)); }
      50%  { transform: translate3d(var(--drift), 55vh, 0) rotate(calc(var(--rot) + 160deg)); }
      100% { transform: translate3d(calc(var(--drift) * -0.3), 120vh, 0) rotate(calc(var(--rot) + 360deg)); }
    }

    .fly {
      position: absolute;
      left: var(--left);
      top: var(--top);
      width: var(--size);
      height: var(--size);
      border-radius: 999px;
      background: rgba(250,204,21,0.92);
      box-shadow: 0 0 18px rgba(250,204,21,0.38), 0 0 40px rgba(56,189,248,0.10);
      opacity: 0.75;
      filter: blur(0.25px);
      animation: flyMove var(--dur) ease-in-out infinite alternate, flyPulse 2.2s ease-in-out infinite;
    }
    @keyframes flyMove {
      from { transform: translate3d(0, 0, 0); }
      to { transform: translate3d(var(--dx), var(--dy), 0); }
    }
    @keyframes flyPulse {
      0%, 100% { opacity: 0.35; transform: scale(0.9); }
      50% { opacity: 0.90; transform: scale(1.15); }
    }

    .menu-tip.swap { animation: tipSwap .55s ease; }
    @keyframes tipSwap {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="text-slate-100">

  <div class="fixed inset-0">
    <canvas id="game" class="absolute inset-0 h-screen w-screen block"></canvas>

    <!-- HUD (أثناء اللعب فقط) -->
    <div id="hud" class="pointer-events-none absolute inset-x-0 top-0 p-3 hidden">
      <div class="mx-auto flex w-full max-w-[1100px] items-start justify-between gap-3">
        <div class="glass pointer-events-auto rounded-2xl border border-white/10 px-3 py-2">
          <div class="flex items-center gap-3">
            <div class="kids-chip rounded-xl px-3 py-2">
              <div class="text-[11px] text-slate-200">GARDEN</div>
              <div class="text-[11px] text-slate-300">by <span class="kbd text-slate-100 font-semibold">Ali tarek</span></div>
            </div>
            <div class="rounded-xl bg-emerald-400/15 border border-emerald-300/20 px-3 py-2">
              <div class="text-[11px] text-slate-300">النقاط</div>
              <div class="kbd text-lg font-semibold" id="score">0</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/10 px-3 py-2">
              <div class="text-[11px] text-slate-300">المتبقي</div>
              <div class="kbd text-lg font-semibold"><span id="remaining">—</span></div>
            </div>
            <div class="hidden sm:block rounded-xl bg-white/5 border border-white/10 px-3 py-2">
              <div class="text-[11px] text-slate-300">أفضل نتيجة</div>
              <div class="kbd text-lg font-semibold" id="bestScore">0</div>
            </div>
          </div>
        </div>

        <div class="glass pointer-events-auto rounded-2xl border border-white/10 p-2">
          <div class="flex gap-2">
            <button id="btnPause" class="btn rounded-xl px-3 py-2 text-sm font-semibold">إيقاف (P)</button>
            <button id="btnRestart" class="rounded-xl bg-emerald-500/90 px-3 py-2 text-sm font-semibold text-emerald-950 hover:bg-emerald-400 active:translate-y-px transition">إعادة (R)</button>
            <button id="btnOpenSettings" class="btn rounded-xl px-3 py-2 text-sm font-semibold">الإعدادات</button>
          </div>
        </div>
      </div>
    </div>

    <!-- تحكم لمس للجوال -->
    <div id="mobileControls" class="absolute bottom-4 left-4 right-4 flex items-end justify-between gap-3 hidden">
      <div class="select-none rounded-2xl border border-white/10 bg-slate-950/35 p-2 backdrop-blur md:hidden">
        <div class="grid grid-cols-3 gap-2">
          <button class="dpad-btn col-start-2 rounded-xl px-4 py-3 text-base" data-dir="up">▲</button>
          <button class="dpad-btn rounded-xl px-4 py-3 text-base" data-dir="left">◀</button>
          <button class="dpad-btn rounded-xl px-4 py-3 text-base" data-dir="down">▼</button>
          <button class="dpad-btn rounded-xl px-4 py-3 text-base" data-dir="right">▶</button>
        </div>
      </div>
      <div class="hidden md:block"></div>
      <div class="glass rounded-2xl border border-white/10 px-3 py-2">
        <div class="text-[11px] text-slate-300">الهدف</div>
        <div class="text-sm font-semibold">اجمع الزهور وتجنب الزومبي</div>
      </div>
    </div>

    <!-- قائمة رئيسية مثل الألعاب (Panels داخل نفس الصفحة) -->
    <div id="menu" class="menu-scene fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-gradient-to-b from-slate-950 via-slate-950/70 to-slate-950"></div>

      <!-- Aurora + grass layer -->
      <div class="menu-aurora absolute inset-0"></div>
      <div class="menu-grass absolute inset-x-0 bottom-0 h-[42vh]"></div>

      <!-- Floating decorations -->
      <div id="menuDecor" class="pointer-events-none absolute inset-0 overflow-hidden"></div>

      <div class="relative w-full max-w-md">
        <div id="menuCard" class="menu-card glass menu-sheen rounded-3xl border border-white/10 p-6">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div id="menuTagline" class="menu-tagline text-xs text-slate-200/90">مغامرة حديقة مرحة — اجمع الزهور قبل أن يقترب الزومبي!</div>
              <div class="mt-2">
                <span class="kids-badge kids-logo logo-pop inline-flex items-center rounded-2xl px-4 py-2 text-3xl font-black">
                  GARDEN
                </span>
              </div>
              <div class="mt-2 text-xs text-slate-300">Developed by <span class="kbd font-semibold text-slate-100">Ali tarek</span></div>
            </div>
            <div class="rounded-2xl bg-white/5 border border-white/10 px-3 py-2 text-xs text-slate-200">
              v1
            </div>
          </div>

          <!-- Main Panel -->
          <div id="menuPanelMain" class="mt-5 panel-enter">
            <div class="space-y-3">
              <button id="menuStart" class="menu-btn menu-primary cta-btn">Start Game</button>
              <button id="menuContinue" class="menu-btn hidden">Continue</button>
              <button id="menuSettings" class="menu-btn">Settings</button>
              <button id="menuHow" class="menu-btn">How to Play</button>
            </div>
            <div class="mt-4 flex items-center justify-between text-xs text-slate-300">
              <div>أفضل نتيجة: <span class="kbd font-semibold text-slate-100" id="bestScoreMenu">0</span></div>
              <div class="text-slate-400">Enter للبدء</div>
            </div>
          </div>

          <!-- Settings Panel -->
          <div id="menuPanelSettings" class="mt-5 hidden panel-enter">
            <div class="flex items-center justify-between">
              <div class="text-lg font-extrabold">Settings</div>
              <button id="settingsBack" class="btn rounded-xl px-3 py-2 text-sm font-semibold">Back</button>
            </div>

            <div class="mt-4 space-y-4">
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="text-sm font-bold">الصعوبة</div>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button class="chip rounded-xl px-4 py-2 text-sm font-semibold" data-diff="easy" aria-pressed="false">سهل</button>
                  <button class="chip rounded-xl px-4 py-2 text-sm font-semibold" data-diff="normal" aria-pressed="true">عادي</button>
                  <button class="chip rounded-xl px-4 py-2 text-sm font-semibold" data-diff="hard" aria-pressed="false">صعب</button>
                </div>
              </div>

              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-bold">الصوت</div>
                  <label class="inline-flex items-center gap-2 text-sm">
                    <input id="toggleSound" type="checkbox" class="h-4 w-4" />
                    <span class="text-slate-200">تفعيل</span>
                  </label>
                </div>
                <div class="mt-3">
                  <div class="flex items-center justify-between text-xs text-slate-300">
                    <span>مستوى الصوت</span>
                    <span class="kbd" id="volumeLabel">70%</span>
                  </div>
                  <input id="volume" type="range" min="0" max="100" value="70" class="mt-2 w-full" />
                </div>
              </div>

              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-bold">تحكم الجوال</div>
                  <label class="inline-flex items-center gap-2 text-sm">
                    <input id="toggleMobile" type="checkbox" class="h-4 w-4" />
                    <span class="text-slate-200">إظهار D-Pad</span>
                  </label>
                </div>
                <div class="mt-2 text-xs text-slate-300">يظهر تلقائيًا على الشاشات اللمسية عند تفعيله.</div>
              </div>

              <div class="flex gap-2">
                <button id="settingsSave" class="menu-btn menu-primary">Save</button>
                <button id="settingsReset" class="menu-btn">Reset</button>
              </div>
            </div>
          </div>

          <!-- How to play Panel -->
          <div id="menuPanelHow" class="mt-5 hidden panel-enter">
            <div class="flex items-center justify-between">
              <div class="text-lg font-extrabold">How to Play</div>
              <button id="howBack" class="btn rounded-xl px-3 py-2 text-sm font-semibold">Back</button>
            </div>

            <div class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-4">
              <ul class="space-y-2 text-sm text-slate-200">
                <li class="flex justify-between gap-3"><span>الحركة</span><span class="text-slate-300">WASD / الأسهم</span></li>
                <li class="flex justify-between gap-3"><span>إيقاف/متابعة</span><span class="text-slate-300">P أو Esc</span></li>
                <li class="flex justify-between gap-3"><span>إعادة</span><span class="text-slate-300">R</span></li>
              </ul>
              <div class="mt-3 text-xs text-slate-300">اجمع كل الزهور وتجنب الزومبي: لمسة واحدة = موت.</div>
            </div>
          </div>

        </div>

        <div class="mt-3 text-center text-[11px] text-slate-300">
          <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1">
            <span class="text-[10px] font-bold text-amber-200/90">TIP</span>
            <span id="menuTip" class="menu-tip">اجمع الزهور بسرعة… الزومبي يسمع خطواتك!</span>
          </span>
        </div>
      </div>
    </div>

    <!-- نافذة (Pause/Win/Dead/Settings in-game) -->
    <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
      <div class="absolute inset-0 bg-slate-950/75"></div>
      <div class="relative w-full max-w-lg rounded-3xl border border-white/10 bg-slate-900/60 p-6 backdrop-blur">
        <div class="mb-2 flex items-center justify-between">
          <div class="kids-logo text-sm font-black tracking-wide text-emerald-200">GARDEN</div>
          <div class="text-[11px] text-slate-300">by <span class="kbd text-slate-100 font-semibold">Ali tarek</span></div>
        </div>
        <h3 id="modalTitle" class="text-xl font-bold">—</h3>
        <p id="modalText" class="mt-2 text-sm text-slate-200">—</p>
        <div class="mt-5 flex flex-wrap gap-2">
          <button id="modalResume" class="btn rounded-xl px-4 py-3 text-sm font-semibold">متابعة</button>
          <button id="modalRestart" class="rounded-xl bg-emerald-500/90 px-4 py-3 text-sm font-semibold text-emerald-950 hover:bg-emerald-400">إعادة اللعب</button>
          <button id="modalMenu" class="btn rounded-xl px-4 py-3 text-sm font-semibold">القائمة</button>
          <button id="modalSettings" class="btn rounded-xl px-4 py-3 text-sm font-semibold">الإعدادات</button>
        </div>
        <p class="mt-4 text-xs text-slate-300">P إيقاف/متابعة — R إعادة</p>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const canvas = document.getElementById('game');
      const ctx = canvas.getContext('2d');

      const hud = document.getElementById('hud');
      const mobileControls = document.getElementById('mobileControls');

      const elScore = document.getElementById('score');
      const elRemaining = document.getElementById('remaining');
      const elBestScore = document.getElementById('bestScore');

      const btnRestart = document.getElementById('btnRestart');
      const btnPause = document.getElementById('btnPause');
      const btnOpenSettings = document.getElementById('btnOpenSettings');

      const menu = document.getElementById('menu');
      const menuPanelMain = document.getElementById('menuPanelMain');
      const menuPanelSettings = document.getElementById('menuPanelSettings');
      const menuPanelHow = document.getElementById('menuPanelHow');

      // Menu decor / hype
      const menuDecor = document.getElementById('menuDecor');
      const menuCard = document.getElementById('menuCard');
      const menuTagline = document.getElementById('menuTagline');
      const menuTip = document.getElementById('menuTip');

      const menuStart = document.getElementById('menuStart');
      const menuContinue = document.getElementById('menuContinue');
      const menuSettingsBtn = document.getElementById('menuSettings');
      const menuHowBtn = document.getElementById('menuHow');

      const settingsBack = document.getElementById('settingsBack');
      const howBack = document.getElementById('howBack');

      const settingsSave = document.getElementById('settingsSave');
      const settingsReset = document.getElementById('settingsReset');

      const toggleSound = document.getElementById('toggleSound');
      const volume = document.getElementById('volume');
      const volumeLabel = document.getElementById('volumeLabel');
      const toggleMobile = document.getElementById('toggleMobile');

      const bestScoreMenu = document.getElementById('bestScoreMenu');

      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const modalText = document.getElementById('modalText');
      const modalResume = document.getElementById('modalResume');
      const modalRestart = document.getElementById('modalRestart');
      const modalMenu = document.getElementById('modalMenu');
      const modalSettings = document.getElementById('modalSettings');

      // إعدادات العالم
      const WORLD = { w: 2400, h: 1600 };
      const PLAYER = {
        x: 260, y: 260,
        r: 18,
        speed: 280,
        vx: 0, vy: 0,
        facing: 0,
        step: 0
      };
      const CAMERA = { x: 0, y: 0, tx: 0, ty: 0 };
      const INPUT = { up: false, down: false, left: false, right: false };

      const DIFF = {
        easy:   { zombies: 4,  zSpeed: 135, aggro: 320 },
        normal: { zombies: 7,  zSpeed: 165, aggro: 380 },
        hard:   { zombies: 11, zSpeed: 205, aggro: 440 },
      };

      const STORAGE_KEY_SETTINGS = 'gardenGameSettings_v1';
      const STORAGE_KEY_BEST = 'gardenGameBestScore_v1';

      let settings = {
        difficulty: 'normal',
        sound: true,
        volume: 0.70,
        mobileDpad: true
      };

      function loadSettings() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY_SETTINGS);
          if (raw) {
            const s = JSON.parse(raw);
            settings = {
              difficulty: (s.difficulty && DIFF[s.difficulty]) ? s.difficulty : 'normal',
              sound: typeof s.sound === 'boolean' ? s.sound : true,
              volume: typeof s.volume === 'number' ? clamp(s.volume, 0, 1) : 0.70,
              mobileDpad: typeof s.mobileDpad === 'boolean' ? s.mobileDpad : true,
            };
          }
        } catch {}
      }

      function saveSettings() {
        localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
      }

      function getBestScore() {
        const v = Number(localStorage.getItem(STORAGE_KEY_BEST) || '0');
        return Number.isFinite(v) ? v : 0;
      }

      function setBestScore(v) {
        const cur = getBestScore();
        if (v > cur) localStorage.setItem(STORAGE_KEY_BEST, String(v));
      }

      function refreshBestScoreUI() {
        const b = getBestScore();
        elBestScore.textContent = String(b);
        bestScoreMenu.textContent = String(b);
      }

      function applySettingsToUI() {
        // Difficulty chips
        const diffButtons = Array.from(document.querySelectorAll('[data-diff]'));
        diffButtons.forEach(b => b.setAttribute('aria-pressed', b.dataset.diff === settings.difficulty ? 'true' : 'false'));

        toggleSound.checked = !!settings.sound;
        volume.value = String(Math.round(settings.volume * 100));
        volumeLabel.textContent = `${Math.round(settings.volume * 100)}%`;
        toggleMobile.checked = !!settings.mobileDpad;

        updateControlVisibility();
      }

      function showMenuPanel(name) {
        const set = (el, on) => el.classList.toggle('hidden', !on);
        set(menuPanelMain, name === 'main');
        set(menuPanelSettings, name === 'settings');
        set(menuPanelHow, name === 'how');

        // إعادة تشغيل أنيميشن الدخول
        const active = name === 'main' ? menuPanelMain : name === 'settings' ? menuPanelSettings : menuPanelHow;
        active.classList.remove('panel-enter');
        void active.offsetWidth;
        active.classList.add('panel-enter');
      }

      // ===== Menu hype layer (petals, fireflies, rotating tips, card tilt) =====
      const MENU_TAGLINES = [
        'مغامرة حديقة مرحة — اجمع الزهور قبل أن يقترب الزومبي!',
        'أسرع! كل زهرة = نقاط أكثر… لكن احذر من المطاردة!',
        'لفّ حول الشجيرات وخلّي الزومبي يضيع الطريق!',
        'هدوء الحديقة جميل… لحد ما الزومبي يشم ريحتك!',
      ];
      const MENU_TIPS = [
        'اجمع الزهور بسرعة… الزومبي يسمع خطواتك!',
        'إذا شفت زومبي قريب: لف ورا الشجيرة فورًا!',
        'ابدأ على Easy لو أول مرة تلعب.',
        'تقدر توقف اللعبة بـ P وترجع تكمل.',
      ];

      let taglineI = 0;
      let tipI = 0;
      let menuTextTimer = null;

      function swapText(el, text, cls) {
        if (!el) return;
        el.textContent = text;
        el.classList.remove('swap');
        void el.offsetWidth;
        el.classList.add('swap');
        if (cls) {
          el.classList.remove(cls);
          void el.offsetWidth;
          el.classList.add(cls);
        }
      }

      function startMenuTextRotation() {
        stopMenuTextRotation();
        // immediate refresh
        if (menuTagline) swapText(menuTagline, MENU_TAGLINES[taglineI % MENU_TAGLINES.length], 'swap');
        if (menuTip) swapText(menuTip, MENU_TIPS[tipI % MENU_TIPS.length], 'swap');

        menuTextTimer = setInterval(() => {
          taglineI = (taglineI + 1) % MENU_TAGLINES.length;
          tipI = (tipI + 1) % MENU_TIPS.length;
          if (menuTagline) swapText(menuTagline, MENU_TAGLINES[taglineI], 'swap');
          if (menuTip) swapText(menuTip, MENU_TIPS[tipI], 'swap');
        }, 3200);
      }

      function stopMenuTextRotation() {
        if (menuTextTimer) {
          clearInterval(menuTextTimer);
          menuTextTimer = null;
        }
      }

      function clearMenuDecor() {
        if (!menuDecor) return;
        menuDecor.innerHTML = '';
      }

      function createMenuDecor() {
        if (!menuDecor) return;
        clearMenuDecor();

        const petalColors = [
          ['rgba(248,250,252,0.95)', 'rgba(250,204,21,0.70)'],
          ['rgba(56,189,248,0.80)', 'rgba(34,197,94,0.75)'],
          ['rgba(250,204,21,0.85)', 'rgba(16,185,129,0.75)'],
          ['rgba(167,243,208,0.75)', 'rgba(56,189,248,0.55)'],
        ];

        // Petals
        const petals = 16;
        for (let i = 0; i < petals; i++) {
          const p = document.createElement('div');
          p.className = 'petal';
          const size = 10 + Math.random() * 16;
          const left = Math.random() * 100;
          const top = -30 + Math.random() * 35;
          const dur = 8 + Math.random() * 12;
          const drift = (-40 + Math.random() * 80) + 'px';
          const rot = (-20 + Math.random() * 40) + 'deg';
          const op = 0.18 + Math.random() * 0.28;
          const cc = petalColors[Math.floor(Math.random() * petalColors.length)];

          p.style.setProperty('--size', size + 'px');
          p.style.setProperty('--left', left + '%');
          p.style.setProperty('--top', top + '%');
          p.style.setProperty('--dur', dur + 's');
          p.style.setProperty('--drift', drift);
          p.style.setProperty('--rot', rot);
          p.style.setProperty('--op', String(op));
          p.style.setProperty('--c1', cc[0]);
          p.style.setProperty('--c2', cc[1]);
          p.style.animationDelay = (-Math.random() * dur) + 's';
          menuDecor.appendChild(p);
        }

        // Fireflies
        const flies = 10;
        for (let i = 0; i < flies; i++) {
          const f = document.createElement('div');
          f.className = 'fly';
          const size = 3 + Math.random() * 5;
          const left = Math.random() * 100;
          const top = 10 + Math.random() * 70;
          const dur = 2.4 + Math.random() * 3.8;
          const dx = (-45 + Math.random() * 90) + 'px';
          const dy = (-35 + Math.random() * 75) + 'px';

          f.style.setProperty('--size', size + 'px');
          f.style.setProperty('--left', left + '%');
          f.style.setProperty('--top', top + '%');
          f.style.setProperty('--dur', dur + 's');
          f.style.setProperty('--dx', dx);
          f.style.setProperty('--dy', dy);
          f.style.animationDelay = (-Math.random() * dur) + 's';
          menuDecor.appendChild(f);
        }
      }

      // Card tilt (desktop)
      let tiltBound = false;
      function enableMenuTilt() {
        if (!menuCard || tiltBound) return;
        tiltBound = true;
        const onMove = (e) => {
          if (state !== 'menu') return;
          const r = menuCard.getBoundingClientRect();
          const cx = r.left + r.width / 2;
          const cy = r.top + r.height / 2;
          const dx = (e.clientX - cx) / (r.width / 2);
          const dy = (e.clientY - cy) / (r.height / 2);
          const ry = clamp(dx, -1, 1) * 7;
          const rx = clamp(-dy, -1, 1) * 6;
          menuCard.style.setProperty('--rx', rx.toFixed(2) + 'deg');
          menuCard.style.setProperty('--ry', ry.toFixed(2) + 'deg');
          menuCard.style.setProperty('--lift', '-2px');
        };
        const onLeave = () => {
          menuCard.style.setProperty('--rx', '0deg');
          menuCard.style.setProperty('--ry', '0deg');
          menuCard.style.setProperty('--lift', '0px');
        };
        menuCard.addEventListener('pointermove', onMove);
        menuCard.addEventListener('pointerleave', onLeave);
      }

      function onEnterMenu() {
        createMenuDecor();
        startMenuTextRotation();
        enableMenuTilt();
      }

      function onExitMenu() {
        stopMenuTextRotation();
        clearMenuDecor();
        if (menuCard) {
          menuCard.style.setProperty('--rx', '0deg');
          menuCard.style.setProperty('--ry', '0deg');
          menuCard.style.setProperty('--lift', '0px');
        }
      }

      // صوت بسيط (WebAudio)
      let audioCtx = null;
      function ensureAudio() {
        if (!settings.sound) return null;
        if (!audioCtx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return null;
          audioCtx = new Ctx();
        }
        if (audioCtx.state === 'suspended') {
          audioCtx.resume().catch(() => {});
        }
        return audioCtx;
      }

      function playTone(freq, dur, type = 'sine', gain = 0.15) {
        if (!settings.sound) return;
        const ac = ensureAudio();
        if (!ac) return;
        const t0 = ac.currentTime;

        const o = ac.createOscillator();
        const g = ac.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, t0);

        const vol = settings.volume;
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(Math.max(0.0001, gain * vol), t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

        o.connect(g);
        g.connect(ac.destination);
        o.start(t0);
        o.stop(t0 + dur + 0.02);
      }

      function sfxPickup() { playTone(660, 0.10, 'triangle', 0.12); playTone(880, 0.08, 'sine', 0.08); }
      function sfxDead() { playTone(220, 0.22, 'sawtooth', 0.16); playTone(140, 0.28, 'square', 0.12); }
      function sfxWin() { playTone(523.25, 0.12, 'triangle', 0.12); setTimeout(() => playTone(659.25, 0.12, 'triangle', 0.12), 120); setTimeout(() => playTone(783.99, 0.18, 'triangle', 0.12), 240); }

      // الحالة
      let state = 'boot'; // boot | menu | playing | paused | won | dead
      let score = 0;
      let gameTime = 0;
      let globalTime = 0;

      // شجيرات (عوائق)
      const hedges = [
        { x: 180, y: 520, w: 560, h: 52 },
        { x: 780, y: 310, w: 52, h: 560 },
        { x: 1040, y: 180, w: 760, h: 58 },
        { x: 1280, y: 450, w: 460, h: 52 },
        { x: 360, y: 900, w: 58, h: 460 },
        { x: 560, y: 1080, w: 560, h: 52 },
        { x: 1220, y: 980, w: 58, h: 380 },
        { x: 1520, y: 1120, w: 560, h: 52 },
        { x: 1760, y: 640, w: 52, h: 420 },
        { x: 320, y: 260, w: 320, h: 44 },
        { x: 480, y: 304, w: 44, h: 260 },
      ];

      // توليد تفاصيل ثابتة للشجيرات
      function mulberry32(a) {
        return function() {
          let t = a += 0x6D2B79F5;
          t = Math.imul(t ^ (t >>> 15), t | 1);
          t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        }
      }

      function buildHedgeDetails() {
        for (const h of hedges) {
          const seed = ((h.x * 73856093) ^ (h.y * 19349663) ^ (h.w * 83492791) ^ (h.h * 2654435761)) >>> 0;
          const rnd = mulberry32(seed);
          const leafCount = Math.max(20, Math.floor((h.w * h.h) / 5200));
          h.leaves = [];
          for (let i = 0; i < leafCount; i++) {
            h.leaves.push({
              x: 6 + rnd() * (h.w - 12),
              y: 6 + rnd() * (h.h - 12),
              r: 1.2 + rnd() * 2.2,
              a: 0.10 + rnd() * 0.22,
              g: rnd() < 0.25 ? 1 : 0
            });
          }
        }
      }

      // عناصر اللعب
      const flowers = [];
      const zombies = [];
      const particles = [];

      const FLOWER_COUNT = 14;

      function rand(min, max) { return Math.random() * (max - min) + min; }
      function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
      function dist2(ax, ay, bx, by) { const dx = ax - bx, dy = ay - by; return dx*dx + dy*dy; }

      function rectCircleCollide(rect, cx, cy, cr) {
        const closestX = clamp(cx, rect.x, rect.x + rect.w);
        const closestY = clamp(cy, rect.y, rect.y + rect.h);
        const dx = cx - closestX;
        const dy = cy - closestY;
        return (dx * dx + dy * dy) <= cr * cr;
      }

      function updateUI() {
        elScore.textContent = score;
        const rem = flowers.reduce((a, f) => a + (!f.taken ? 1 : 0), 0);
        elRemaining.textContent = rem;
      }

      function showModal(title, text, opts = {}) {
        modalTitle.textContent = title;
        modalText.textContent = text;
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        modalResume.style.display = opts.resume ? '' : 'none';
        modalRestart.style.display = opts.restart ? '' : 'none';
        modalMenu.style.display = opts.menu ? '' : 'none';
        modalSettings.style.display = opts.settings ? '' : 'none';
      }

      function hideModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      function isTouchDevice() {
        return (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) || ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
      }

      function updateControlVisibility() {
        const playingUI = (state === 'playing' || state === 'paused' || state === 'won' || state === 'dead');
        const showDpad = playingUI && settings.mobileDpad && isTouchDevice();
        mobileControls.classList.toggle('hidden', !showDpad);
      }

      function setState(next) {
        const prev = state;
        state = next;

        const playingUI = (state === 'playing' || state === 'paused' || state === 'won' || state === 'dead');
        hud.classList.toggle('hidden', !playingUI);

        menu.classList.toggle('hidden', state !== 'menu');
        menu.classList.toggle('flex', state === 'menu');

        if (prev !== 'menu' && state === 'menu') onEnterMenu();
        if (prev === 'menu' && state !== 'menu') onExitMenu();

        if (state === 'playing') hideModal();
        if (state === 'menu') {
          showMenuPanel('main');
          refreshBestScoreUI();
          menuContinue.classList.toggle('hidden', true); // reserved
        }

        updateControlVisibility();
      }

      function cameraFollow(dt) {
        const viewW = window.innerWidth;
        const viewH = window.innerHeight;
        CAMERA.tx = clamp(PLAYER.x - viewW / 2, 0, WORLD.w - viewW);
        CAMERA.ty = clamp(PLAYER.y - viewH / 2, 0, WORLD.h - viewH);
        const smooth = 10;
        const a = 1 - Math.exp(-smooth * dt);
        CAMERA.x += (CAMERA.tx - CAMERA.x) * a;
        CAMERA.y += (CAMERA.ty - CAMERA.y) * a;
      }

      function movePlayerWithCollisions(nx, ny) {
        let x = clamp(nx, PLAYER.r, WORLD.w - PLAYER.r);
        for (const h of hedges) {
          if (rectCircleCollide(h, x, PLAYER.y, PLAYER.r)) { x = PLAYER.x; break; }
        }
        let y = clamp(ny, PLAYER.r, WORLD.h - PLAYER.r);
        for (const h of hedges) {
          if (rectCircleCollide(h, x, y, PLAYER.r)) { y = PLAYER.y; break; }
        }
        PLAYER.x = x;
        PLAYER.y = y;
      }

      function moveMobWithCollisions(mob, r, nx, ny) {
        let x = clamp(nx, r, WORLD.w - r);
        for (const h of hedges) {
          if (rectCircleCollide(h, x, mob.y, r)) {
            x = mob.x;
            mob.vx *= -0.2;
            break;
          }
        }
        let y = clamp(ny, r, WORLD.h - r);
        for (const h of hedges) {
          if (rectCircleCollide(h, x, y, r)) {
            y = mob.y;
            mob.vy *= -0.2;
            break;
          }
        }
        mob.x = x;
        mob.y = y;
      }

      function spawnPickupParticles(x, y) {
        for (let i = 0; i < 18; i++) {
          particles.push({
            x, y,
            vx: rand(-150, 150),
            vy: rand(-210, 40),
            life: rand(0.35, 0.75),
            t: 0,
            r: rand(2, 4),
            kind: 'pickup'
          });
        }
      }

      function spawnHitParticles(x, y) {
        for (let i = 0; i < 34; i++) {
          particles.push({
            x, y,
            vx: rand(-220, 220),
            vy: rand(-260, 120),
            life: rand(0.25, 0.70),
            t: 0,
            r: rand(2, 5),
            kind: 'hit'
          });
        }
      }

      function pointIsSafeCircle(x, y, r, extra = 0) {
        if (x < r || y < r || x > WORLD.w - r || y > WORLD.h - r) return false;
        for (const h of hedges) {
          if (rectCircleCollide(h, x, y, r + extra)) return false;
        }
        return true;
      }

      function resetGame() {
        score = 0;
        gameTime = 0;

        PLAYER.x = 260;
        PLAYER.y = 260;
        PLAYER.vx = 0;
        PLAYER.vy = 0;
        PLAYER.facing = 0;
        PLAYER.step = 0;

        flowers.length = 0;
        zombies.length = 0;
        particles.length = 0;

        // زهور
        let attempts = 0;
        while (flowers.length < FLOWER_COUNT && attempts < 9000) {
          attempts++;
          const f = { x: rand(90, WORLD.w - 90), y: rand(90, WORLD.h - 90), r: rand(10, 14), taken: false };
          if (dist2(f.x, f.y, PLAYER.x, PLAYER.y) < 320 * 320) continue;
          if (!pointIsSafeCircle(f.x, f.y, f.r + 12, 6)) continue;
          flowers.push(f);
        }

        // زومبي
        const cfg = DIFF[settings.difficulty];
        attempts = 0;
        while (zombies.length < cfg.zombies && attempts < 12000) {
          attempts++;
          const z = {
            x: rand(120, WORLD.w - 120),
            y: rand(120, WORLD.h - 120),
            r: 19,
            vx: 0, vy: 0,
            facing: rand(-Math.PI, Math.PI),
            step: rand(0, 10),
            wanderA: rand(-Math.PI, Math.PI),
            wanderT: rand(0.2, 1.2)
          };
          if (dist2(z.x, z.y, PLAYER.x, PLAYER.y) < 520 * 520) continue;
          if (!pointIsSafeCircle(z.x, z.y, z.r + 8, 10)) continue;
          zombies.push(z);
        }

        updateUI();
      }

      function startGame() {
        ensureAudio();
        resetGame();
        setState('playing');
      }

      function die() {
        if (state !== 'playing') return;
        setState('dead');
        spawnHitParticles(PLAYER.x, PLAYER.y);
        sfxDead();
        setBestScore(score);
        refreshBestScoreUI();
        showModal('انتهت اللعبة', `لمسك الزومبي. نقاطك: ${score}.`, { resume: false, restart: true, menu: true, settings: true });
      }

      function win() {
        if (state !== 'playing') return;
        setState('won');
        sfxWin();
        setBestScore(score);
        refreshBestScoreUI();
        showModal('مبروك!', `جمعت كل الزهور. نقاطك: ${score}.`, { resume: false, restart: true, menu: true, settings: true });
      }

      function setPaused(value) {
        if (state === 'won' || state === 'dead' || state === 'menu') return;
        if (value) {
          setState('paused');
          showModal('إيقاف مؤقت', 'اضغط متابعة أو (P) للعودة.', { resume: true, restart: true, menu: true, settings: true });
        } else {
          setState('playing');
          lastT = performance.now();
        }
      }

      // تحكم لوحة المفاتيح
      const keyMap = {
        ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right',
        w: 'up', s: 'down', a: 'left', d: 'right'
      };

      window.addEventListener('keydown', (e) => {
        const k = e.key;

        if (k === 'Enter' && state === 'menu') {
          e.preventDefault();
          startGame();
          return;
        }

        if (k === 'p' || k === 'P') { e.preventDefault(); setPaused(state !== 'paused'); return; }
        if (k === 'Escape') { e.preventDefault(); if (state === 'playing') setPaused(true); else if (state === 'paused') setPaused(false); return; }
        if (k === 'r' || k === 'R') {
          e.preventDefault();
          if (state !== 'menu') { startGame(); }
          else { startGame(); }
          return;
        }

        const mapped = keyMap[k];
        if (mapped) { e.preventDefault(); INPUT[mapped] = true; }
      }, { passive: false });

      window.addEventListener('keyup', (e) => {
        const mapped = keyMap[e.key];
        if (mapped) { e.preventDefault(); INPUT[mapped] = false; }
      }, { passive: false });

      // D-Pad للموبايل
      function bindDpad() {
        const btns = document.querySelectorAll('.dpad-btn');
        btns.forEach(btn => {
          const dir = btn.dataset.dir;
          const down = (e) => { e.preventDefault(); ensureAudio(); INPUT[dir] = true; };
          const up = (e) => { e.preventDefault(); INPUT[dir] = false; };
          btn.addEventListener('pointerdown', down, { passive: false });
          btn.addEventListener('pointerup', up, { passive: false });
          btn.addEventListener('pointercancel', up, { passive: false });
          btn.addEventListener('pointerleave', up, { passive: false });
        });
      }
      bindDpad();

      // أزرار HUD
      btnRestart.addEventListener('click', () => startGame());
      btnPause.addEventListener('click', () => setPaused(state !== 'paused'));
      btnOpenSettings.addEventListener('click', () => {
        if (state === 'playing') setPaused(true);
        openSettingsFromModal();
      });

      // قائمة رئيسية
      menuStart.addEventListener('click', () => startGame());
      menuSettingsBtn.addEventListener('click', () => { ensureAudio(); showMenuPanel('settings'); });
      menuHowBtn.addEventListener('click', () => { ensureAudio(); showMenuPanel('how'); });
      menuContinue.addEventListener('click', () => { /* reserved */ });

      settingsBack.addEventListener('click', () => showMenuPanel('main'));
      howBack.addEventListener('click', () => showMenuPanel('main'));

      // تغيير الصعوبة (في الإعدادات)
      const diffButtons = Array.from(document.querySelectorAll('[data-diff]'));
      diffButtons.forEach(b => {
        b.addEventListener('click', () => {
          settings.difficulty = b.dataset.diff;
          diffButtons.forEach(x => x.setAttribute('aria-pressed', x === b ? 'true' : 'false'));
        });
      });

      // إعدادات الصوت والجوال
      toggleSound.addEventListener('change', () => {
        settings.sound = toggleSound.checked;
        ensureAudio();
      });

      volume.addEventListener('input', () => {
        settings.volume = clamp(Number(volume.value) / 100, 0, 1);
        volumeLabel.textContent = `${Math.round(settings.volume * 100)}%`;
      });

      toggleMobile.addEventListener('change', () => {
        settings.mobileDpad = toggleMobile.checked;
        updateControlVisibility();
      });

      settingsSave.addEventListener('click', () => {
        ensureAudio();
        saveSettings();
        playTone(880, 0.08, 'triangle', 0.08);
        showMenuPanel('main');
      });

      settingsReset.addEventListener('click', () => {
        ensureAudio();
        settings = { difficulty: 'normal', sound: true, volume: 0.70, mobileDpad: true };
        applySettingsToUI();
        saveSettings();
        playTone(330, 0.10, 'sine', 0.08);
      });

      function openSettingsFromModal() {
        // افتح نفس إعدادات القائمة لكن فوق اللعبة
        showModal('الإعدادات', 'غيّر الصعوبة/الصوت من القائمة الرئيسية (Settings).', { resume: true, restart: true, menu: true, settings: false });
      }

      // Modal
      modalResume.addEventListener('click', () => setPaused(false));
      modalRestart.addEventListener('click', () => startGame());
      modalMenu.addEventListener('click', () => {
        setPaused(false);
        setState('menu');
        hideModal();
      });
      modalSettings.addEventListener('click', () => {
        // أفضل تجربة: فتح إعدادات القائمة
        setPaused(false);
        setState('menu');
        hideModal();
        showMenuPanel('settings');
      });

      window.addEventListener('blur', () => {
        INPUT.up = INPUT.down = INPUT.left = INPUT.right = false;
      });

      // إعداد الكانفاس
      function resize() {
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        canvas.width = Math.floor(window.innerWidth * dpr);
        canvas.height = Math.floor(window.innerHeight * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      window.addEventListener('resize', () => { resize(); updateControlVisibility(); });

      function update(dt) {
        if (state !== 'playing') return;

        gameTime += dt;

        // حركة اللاعب
        let ax = 0, ay = 0;
        if (INPUT.left) ax -= 1;
        if (INPUT.right) ax += 1;
        if (INPUT.up) ay -= 1;
        if (INPUT.down) ay += 1;
        const len = Math.hypot(ax, ay) || 1;
        ax /= len; ay /= len;

        const targetVx = ax * PLAYER.speed;
        const targetVy = ay * PLAYER.speed;
        const smoothing = 18;
        PLAYER.vx += (targetVx - PLAYER.vx) * (1 - Math.exp(-smoothing * dt));
        PLAYER.vy += (targetVy - PLAYER.vy) * (1 - Math.exp(-smoothing * dt));

        const nx = PLAYER.x + PLAYER.vx * dt;
        const ny = PLAYER.y + PLAYER.vy * dt;
        movePlayerWithCollisions(nx, ny);

        const sp = Math.hypot(PLAYER.vx, PLAYER.vy);
        if (sp > 12) PLAYER.facing = Math.atan2(PLAYER.vy, PLAYER.vx);
        const walkRate = 10;
        PLAYER.step += (sp / PLAYER.speed) * walkRate * dt;

        // التقاط الزهور
        for (const f of flowers) {
          if (f.taken) continue;
          const rr = PLAYER.r + f.r + 4;
          if (dist2(PLAYER.x, PLAYER.y, f.x, f.y) <= rr * rr) {
            f.taken = true;
            score += 10;
            spawnPickupParticles(f.x, f.y);
            sfxPickup();
          }
        }

        // زومبي
        const cfg = DIFF[settings.difficulty];
        const aggro2 = cfg.aggro * cfg.aggro;

        for (const z of zombies) {
          const d2 = dist2(z.x, z.y, PLAYER.x, PLAYER.y);
          const chasing = d2 < aggro2;

          let tx, ty, speed;
          if (chasing) {
            tx = PLAYER.x;
            ty = PLAYER.y;
            speed = cfg.zSpeed;
          } else {
            z.wanderT -= dt;
            if (z.wanderT <= 0) {
              z.wanderT = rand(0.55, 1.5);
              z.wanderA = rand(-Math.PI, Math.PI);
            }
            tx = z.x + Math.cos(z.wanderA) * 140;
            ty = z.y + Math.sin(z.wanderA) * 140;
            speed = cfg.zSpeed * 0.45;
          }

          let dx = tx - z.x;
          let dy = ty - z.y;
          let l = Math.hypot(dx, dy) || 1;
          dx /= l; dy /= l;

          const tvx = dx * speed;
          const tvy = dy * speed;

          const sm = chasing ? 10 : 7;
          z.vx += (tvx - z.vx) * (1 - Math.exp(-sm * dt));
          z.vy += (tvy - z.vy) * (1 - Math.exp(-sm * dt));

          const znx = z.x + z.vx * dt;
          const zny = z.y + z.vy * dt;
          moveMobWithCollisions(z, z.r, znx, zny);

          const zsp = Math.hypot(z.vx, z.vy);
          if (zsp > 10) z.facing = Math.atan2(z.vy, z.vx);
          z.step += (zsp / cfg.zSpeed) * 9 * dt;

          // موت اللاعب عند اللمس
          const rr = PLAYER.r + z.r - 2;
          if (dist2(PLAYER.x, PLAYER.y, z.x, z.y) <= rr * rr) {
            die();
            break;
          }
        }

        // مؤثرات
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.t += dt;
          p.vy += 540 * dt;
          p.x += p.vx * dt;
          p.y += p.vy * dt;
          if (p.t >= p.life) particles.splice(i, 1);
        }

        updateUI();

        // الفوز
        const rem = flowers.reduce((a, f) => a + (!f.taken ? 1 : 0), 0);
        if (rem === 0) win();
      }

      function drawGrassBackground(viewW, viewH) {
        ctx.fillStyle = '#052e16';
        ctx.fillRect(0, 0, viewW, viewH);

        const cell = 64;
        const startX = -((CAMERA.x) % cell);
        const startY = -((CAMERA.y) % cell);

        for (let y = startY; y < viewH + cell; y += cell) {
          for (let x = startX; x < viewW + cell; x += cell) {
            const gx = x + CAMERA.x;
            const gy = y + CAMERA.y;
            const v = (Math.sin(gx * 0.008) + Math.cos(gy * 0.009)) * 0.5;
            const a = 0.055 + (v > 0 ? 0.06 : 0.03);
            ctx.fillStyle = v > 0 ? `rgba(16, 185, 129, ${a})` : `rgba(34, 197, 94, ${a})`;
            ctx.fillRect(x, y, cell, cell);

            ctx.strokeStyle = 'rgba(187, 247, 208, 0.035)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x + 10, y + 52);
            ctx.lineTo(x + 18, y + 12);
            ctx.moveTo(x + 38, y + 58);
            ctx.lineTo(x + 48, y + 16);
            ctx.stroke();
          }
        }

        ctx.strokeStyle = 'rgba(255,255,255,0.10)';
        ctx.lineWidth = 2;
        ctx.strokeRect(-CAMERA.x, -CAMERA.y, WORLD.w, WORLD.h);
      }

      function drawPaths() {
        const px = 120 - CAMERA.x;
        const py = 120 - CAMERA.y;
        ctx.fillStyle = 'rgba(245, 158, 11, 0.09)';
        roundRect(ctx, px, py, 560, 130, 30);
        ctx.fill();

        ctx.fillStyle = 'rgba(245, 158, 11, 0.07)';
        roundRect(ctx, 650 - CAMERA.x, 120 - CAMERA.y, 130, 560, 30);
        ctx.fill();

        ctx.strokeStyle = 'rgba(255,255,255,0.06)';
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      function drawHedges() {
        for (const h of hedges) {
          const x = h.x - CAMERA.x;
          const y = h.y - CAMERA.y;

          ctx.fillStyle = 'rgba(0,0,0,0.18)';
          roundRect(ctx, x + 5, y + 6, h.w, h.h, 16);
          ctx.fill();

          const g = ctx.createLinearGradient(x, y, x, y + h.h);
          g.addColorStop(0, '#166534');
          g.addColorStop(1, '#0f3d22');
          ctx.fillStyle = g;
          roundRect(ctx, x, y, h.w, h.h, 16);
          ctx.fill();

          ctx.strokeStyle = 'rgba(134, 239, 172, 0.20)';
          ctx.lineWidth = 2;
          roundRect(ctx, x + 1, y + 1, h.w - 2, h.h - 2, 15);
          ctx.stroke();

          if (h.leaves) {
            for (const lf of h.leaves) {
              ctx.fillStyle = lf.g
                ? `rgba(16,185,129,${lf.a})`
                : `rgba(34,197,94,${lf.a})`;
              ctx.beginPath();
              ctx.arc(x + lf.x, y + lf.y, lf.r, 0, Math.PI * 2);
              ctx.fill();
            }
          }
        }
      }

      function drawFlowers() {
        for (const f of flowers) {
          if (f.taken) continue;
          const x = f.x - CAMERA.x;
          const y = f.y - CAMERA.y;

          ctx.fillStyle = 'rgba(0,0,0,0.20)';
          ctx.beginPath();
          ctx.ellipse(x + 3, y + 5, f.r * 1.05, f.r * 0.7, 0, 0, Math.PI * 2);
          ctx.fill();

          ctx.strokeStyle = 'rgba(34,197,94,0.95)';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(x, y + f.r * 0.4);
          ctx.lineTo(x + Math.sin((f.x + globalTime * 20) * 0.02) * 6, y + f.r * 2.2);
          ctx.stroke();

          const petals = 7;
          for (let i = 0; i < petals; i++) {
            const a = (i / petals) * Math.PI * 2;
            const px = x + Math.cos(a) * (f.r * 0.85);
            const py = y + Math.sin(a) * (f.r * 0.85);
            ctx.fillStyle = 'rgba(248, 250, 252, 0.96)';
            ctx.beginPath();
            ctx.ellipse(px, py, f.r * 0.6, f.r * 0.36, a, 0, Math.PI * 2);
            ctx.fill();
          }

          ctx.fillStyle = '#f59e0b';
          ctx.beginPath();
          ctx.arc(x, y, f.r * 0.44, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      function drawParticles() {
        for (const p of particles) {
          const t = p.t / p.life;
          const alpha = 1 - t;
          const x = p.x - CAMERA.x;
          const y = p.y - CAMERA.y;

          if (p.kind === 'hit') {
            ctx.fillStyle = `rgba(239,68,68,${0.12 + 0.65 * alpha})`;
            ctx.beginPath();
            ctx.arc(x, y, p.r, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = `rgba(2,6,23,${0.10 + 0.25 * alpha})`;
            ctx.beginPath();
            ctx.arc(x + 2, y + 1, p.r * 0.7, 0, Math.PI * 2);
            ctx.fill();
          } else {
            ctx.fillStyle = `rgba(16,185,129,${0.12 + 0.55 * alpha})`;
            ctx.beginPath();
            ctx.arc(x, y, p.r, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = `rgba(245,158,11,${0.10 + 0.55 * alpha})`;
            ctx.beginPath();
            ctx.arc(x + 2, y - 1, p.r * 0.8, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      }

      // شخصية اللاعب: أكثر واقعية (بدون وجه مبتسم)
      function drawPlayer() {
        const x = PLAYER.x - CAMERA.x;
        const y = PLAYER.y - CAMERA.y;
        const sp = Math.hypot(PLAYER.vx, PLAYER.vy);
        const moving = sp > 8;
        const ang = PLAYER.facing;

        const step = moving ? Math.sin(PLAYER.step * Math.PI * 2) : 0;
        const bob = moving ? Math.abs(step) * 1.2 : 0;

        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(ang);

        // ظل
        ctx.fillStyle = 'rgba(0,0,0,0.28)';
        ctx.beginPath();
        ctx.ellipse(4, 7, 18, 12, 0, 0, Math.PI * 2);
        ctx.fill();

        const swing = step * 4;

        // قدمين
        ctx.fillStyle = '#0f172a';
        roundRect(ctx, -10, 9 + swing * 0.35, 8, 10, 4);
        ctx.fill();
        roundRect(ctx, 2, 9 - swing * 0.35, 8, 10, 4);
        ctx.fill();

        // جسم
        const bodyGrad = ctx.createLinearGradient(-16, -14, 16, 18);
        bodyGrad.addColorStop(0, '#60a5fa');
        bodyGrad.addColorStop(1, '#1d4ed8');
        ctx.fillStyle = bodyGrad;
        roundRect(ctx, -14, -2 - bob, 28, 26, 10);
        ctx.fill();

        // ذراعين
        ctx.fillStyle = '#93c5fd';
        roundRect(ctx, -18, 2 - bob + swing * 0.15, 8, 14, 6);
        ctx.fill();
        roundRect(ctx, 10, 2 - bob - swing * 0.15, 8, 14, 6);
        ctx.fill();

        // رأس
        ctx.fillStyle = '#f1c27d';
        ctx.beginPath();
        ctx.arc(0, -12 - bob, 10.5, 0, Math.PI * 2);
        ctx.fill();

        // شعر
        ctx.fillStyle = 'rgba(15, 23, 42, 0.9)';
        ctx.beginPath();
        ctx.arc(0, -14.5 - bob, 10.6, Math.PI * 1.1, Math.PI * 2.05);
        ctx.fill();

        // عينين (بدون ابتسامة)
        ctx.fillStyle = 'rgba(15,23,42,0.55)';
        ctx.beginPath();
        ctx.arc(-3.5, -13 - bob, 1.6, 0, Math.PI * 2);
        ctx.arc(3.5, -13 - bob, 1.6, 0, Math.PI * 2);
        ctx.fill();

        // اتجاه النظر
        ctx.fillStyle = 'rgba(255,255,255,0.35)';
        ctx.beginPath();
        ctx.arc(8, -10 - bob, 2.2, 0, Math.PI * 2);
        ctx.fill();

        // حدود خفيفة
        ctx.strokeStyle = 'rgba(0,0,0,0.18)';
        ctx.lineWidth = 2;
        roundRect(ctx, -14, -2 - bob, 28, 26, 10);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(0, -12 - bob, 10.5, 0, Math.PI * 2);
        ctx.stroke();

        ctx.restore();
      }

      function drawZombies() {
        for (const z of zombies) {
          const x = z.x - CAMERA.x;
          const y = z.y - CAMERA.y;

          const zsp = Math.hypot(z.vx, z.vy);
          const moving = zsp > 10;
          const step = moving ? Math.sin(z.step * Math.PI * 2) : 0;
          const bob = moving ? Math.abs(step) * 0.9 : 0;

          ctx.save();
          ctx.translate(x, y);
          ctx.rotate(z.facing);

          // ظل
          ctx.fillStyle = 'rgba(0,0,0,0.30)';
          ctx.beginPath();
          ctx.ellipse(3, 7, 18, 12, 0, 0, Math.PI * 2);
          ctx.fill();

          // جسم
          const bodyGrad = ctx.createLinearGradient(-18, -10, 18, 20);
          bodyGrad.addColorStop(0, '#4b5563');
          bodyGrad.addColorStop(1, '#111827');
          ctx.fillStyle = bodyGrad;
          roundRect(ctx, -15, -1 - bob, 30, 26, 10);
          ctx.fill();

          // ذراعين (متقدمين)
          const armSwing = step * 3.2;
          ctx.fillStyle = '#86efac';
          roundRect(ctx, -22, 2 - bob + armSwing * 0.2, 10, 14, 6);
          ctx.fill();
          roundRect(ctx, 12, 2 - bob - armSwing * 0.2, 10, 14, 6);
          ctx.fill();

          // رأس
          const skinGrad = ctx.createLinearGradient(-10, -24, 10, -2);
          skinGrad.addColorStop(0, '#86efac');
          skinGrad.addColorStop(1, '#22c55e');
          ctx.fillStyle = skinGrad;
          ctx.beginPath();
          ctx.arc(0, -12 - bob, 10.6, 0, Math.PI * 2);
          ctx.fill();

          // عينين غامقين
          ctx.fillStyle = 'rgba(2,6,23,0.65)';
          ctx.beginPath();
          ctx.arc(-3.6, -13 - bob, 1.7, 0, Math.PI * 2);
          ctx.arc(3.6, -13 - bob, 1.7, 0, Math.PI * 2);
          ctx.fill();

          // فم بسيط
          ctx.strokeStyle = 'rgba(2,6,23,0.45)';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(-3, -8 - bob);
          ctx.lineTo(3, -8 - bob);
          ctx.stroke();

          // حدود
          ctx.strokeStyle = 'rgba(0,0,0,0.22)';
          ctx.lineWidth = 2;
          roundRect(ctx, -15, -1 - bob, 30, 26, 10);
          ctx.stroke();
          ctx.beginPath();
          ctx.arc(0, -12 - bob, 10.6, 0, Math.PI * 2);
          ctx.stroke();

          ctx.restore();
        }
      }

      function drawMinimap(viewW, viewH) {
        const w = 150, h = 100;
        const pad = 12;
        const x = pad;
        const y = viewH - h - pad - (isTouchDevice() && !mobileControls.classList.contains('hidden') ? 88 : 0);

        ctx.save();
        ctx.globalAlpha = 0.86;
        ctx.fillStyle = 'rgba(2,6,23,0.40)';
        ctx.strokeStyle = 'rgba(255,255,255,0.10)';
        ctx.lineWidth = 1;
        roundRect(ctx, x, y, w, h, 14);
        ctx.fill();
        ctx.stroke();

        const sx = w / WORLD.w;
        const sy = h / WORLD.h;

        // شجيرات
        ctx.fillStyle = 'rgba(34,197,94,0.35)';
        for (const hg of hedges) {
          ctx.fillRect(x + hg.x * sx, y + hg.y * sy, hg.w * sx, hg.h * sy);
        }

        // زومبي
        ctx.fillStyle = 'rgba(34,197,94,0.85)';
        for (const z of zombies) {
          ctx.beginPath();
          ctx.arc(x + z.x * sx, y + z.y * sy, 2.4, 0, Math.PI * 2);
          ctx.fill();
        }

        // زهور
        ctx.fillStyle = 'rgba(245,158,11,0.70)';
        for (const f of flowers) {
          if (f.taken) continue;
          ctx.beginPath();
          ctx.arc(x + f.x * sx, y + f.y * sy, 2.1, 0, Math.PI * 2);
          ctx.fill();
        }

        // لاعب
        ctx.fillStyle = 'rgba(96,165,250,0.95)';
        ctx.beginPath();
        ctx.arc(x + PLAYER.x * sx, y + PLAYER.y * sy, 3.3, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
      }

      function drawOverlays(viewW, viewH) {
        const vignette = ctx.createRadialGradient(
          viewW * 0.5, viewH * 0.55,
          Math.min(viewW, viewH) * 0.2,
          viewW * 0.5, viewH * 0.55,
          Math.max(viewW, viewH) * 0.78
        );
        vignette.addColorStop(0, 'rgba(0,0,0,0)');
        vignette.addColorStop(1, 'rgba(0,0,0,0.30)');
        ctx.fillStyle = vignette;
        ctx.fillRect(0, 0, viewW, viewH);

        if (state === 'dead') {
          const red = ctx.createRadialGradient(viewW * 0.5, viewH * 0.55, 0, viewW * 0.5, viewH * 0.55, Math.max(viewW, viewH) * 0.65);
          red.addColorStop(0, 'rgba(239,68,68,0.00)');
          red.addColorStop(1, 'rgba(239,68,68,0.18)');
          ctx.fillStyle = red;
          ctx.fillRect(0, 0, viewW, viewH);
        }
      }

      function draw() {
        const viewW = window.innerWidth;
        const viewH = window.innerHeight;

        ctx.clearRect(0, 0, viewW, viewH);
        drawGrassBackground(viewW, viewH);
        drawPaths();
        drawHedges();
        drawFlowers();
        drawZombies();
        drawParticles();
        drawPlayer();
        if (state !== 'menu') drawMinimap(viewW, viewH);
        drawOverlays(viewW, viewH);

        // no extra canvas text in menu (menu overlay handles UX)
      }

      function roundRect(c, x, y, w, h, r) {
        const rr = Math.min(r, w / 2, h / 2);
        c.beginPath();
        c.moveTo(x + rr, y);
        c.arcTo(x + w, y, x + w, y + h, rr);
        c.arcTo(x + w, y + h, x, y + h, rr);
        c.arcTo(x, y + h, x, y, rr);
        c.arcTo(x, y, x + w, y, rr);
        c.closePath();
      }

      let lastT = performance.now();
      function loop(t) {
        const dt = Math.min(0.033, (t - lastT) / 1000);
        lastT = t;

        globalTime += dt;

        // كاميرا: في القائمة تتحرك بشكل بسيط للعرض
        if (state === 'menu') {
          const a = 0.12;
          const tx = clamp(720 + Math.sin(globalTime * 0.18) * 240 - window.innerWidth / 2, 0, WORLD.w - window.innerWidth);
          const ty = clamp(560 + Math.cos(globalTime * 0.16) * 180 - window.innerHeight / 2, 0, WORLD.h - window.innerHeight);
          CAMERA.x += (tx - CAMERA.x) * a;
          CAMERA.y += (ty - CAMERA.y) * a;
        } else {
          cameraFollow(state === 'paused' ? 0.00001 : dt);
        }

        update(dt);
        draw();
        requestAnimationFrame(loop);
      }

      // بدء
      loadSettings();
      buildHedgeDetails();
      resize();
      refreshBestScoreUI();
      applySettingsToUI();
      resetGame();
      setState('menu');
      requestAnimationFrame(loop);

      // تهيئة الصوت على أول تفاعل
      window.addEventListener('pointerdown', () => ensureAudio(), { once: true, passive: true });
      window.addEventListener('keydown', () => ensureAudio(), { once: true, passive: true });

    })();
  </script>
</body>
</html>
